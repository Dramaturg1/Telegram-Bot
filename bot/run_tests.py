#!/usr/bin/env python3
"""–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —Å –æ—Ç—á–µ—Ç–æ–º"""

import subprocess
import sys
import json
from datetime import datetime


def run_tests():
    """–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á–µ—Ç–∞"""
    print("=" * 60)
    print("–ó–ê–ü–£–°–ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ß–ê–¢-–ë–û–¢–ê –î–õ–Ø –ï–ì–≠")
    print(f"–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)

    # 1. –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
    print("\nüî¨ –ú–û–î–£–õ–¨–ù–´–ï –¢–ï–°–¢–´")
    print("-" * 40)

    results = {
        "adaptive": run_module_test("tests/test_adaptive.py"),
        "validation": run_module_test("tests/test_validation.py"),
        "database": run_module_test("tests/test_database.py"),
        "integration": run_module_test("tests/test_integration.py"),
        "performance": run_module_test("tests/test_performance.py")
    }

    # 2. –í—Å–µ —Ç–µ—Å—Ç—ã –≤–º–µ—Å—Ç–µ
    print("\nüöÄ –í–°–ï –¢–ï–°–¢–´")
    print("-" * 40)
    run_all_tests()

    # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
    print("\nüìä –û–¢–ß–ï–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò")
    print("-" * 40)
    generate_report(results)

    print("\n" + "=" * 60)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
    print("=" * 60)


def run_module_test(module_path):
    """–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –º–æ–¥—É–ª—è"""
    print(f"\n–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {module_path}")

    result = subprocess.run(
        ["pytest", module_path, "-v", "--tb=short"],
        capture_output=True,
        text=True
    )

    # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if result.returncode == 0:
        print("‚úÖ –£–°–ü–ï–•")
        return {"status": "passed", "output": result.stdout}
    else:
        print("‚ùå –û–®–ò–ë–ö–ê")
        print(result.stderr[:500])  # –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ –æ—à–∏–±–∫–∏
        return {"status": "failed", "output": result.stderr}


def run_all_tests():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    result = subprocess.run(
        ["pytest", "tests/", "-v", "--tb=line"],
        capture_output=True,
        text=True
    )

    print(result.stdout)

    if result.returncode == 0:
        print("\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
    else:
        print(f"\n‚ö†Ô∏è  –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ï–ù–´ (–∫–æ–¥: {result.returncode})")


def generate_report(results):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –∫—É—Ä—Å–æ–≤–æ–π"""

    report_data = [
        {
            "–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π": "–ê–ª–≥–æ—Ä–∏—Ç–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞",
            "–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è": "–ú–æ–¥—É–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤",
            "–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞": "–ó–∞–¥–∞–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —É—Ä–æ–≤–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤",
            "–†–µ–∑—É–ª—å—Ç–∞—Ç": "‚úÖ –£—Å–ø–µ—à–Ω–æ" if results["adaptive"]["status"] == "passed" else "‚ùå –û—à–∏–±–∫–∞"
        },
        {
            "–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤",
            "–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è": "–ú–æ–¥—É–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞": "check_answer() –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å—Ç—Ä–æ–∫–∏",
            "–†–µ–∑—É–ª—å—Ç–∞—Ç": "‚úÖ –£—Å–ø–µ—à–Ω–æ" if results["validation"]["status"] == "passed" else "‚ùå –û—à–∏–±–∫–∞"
        },
        {
            "–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π": "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –ë–î",
            "–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞": "–§–∏–∫—Å–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤, –ø–µ—Ä–µ—Å—á–µ—Ç —É—Ä–æ–≤–Ω—è",
            "–†–µ–∑—É–ª—å—Ç–∞—Ç": "‚úÖ –£—Å–ø–µ—à–Ω–æ" if results["database"]["status"] == "passed" else "‚ùå –û—à–∏–±–∫–∞"
        },
        {
            "–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Rasa",
            "–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞": "–ö–æ–º–∞–Ω–¥—ã /hint –∏ /solution —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ waiting_for_answer",
            "–†–µ–∑—É–ª—å—Ç–∞—Ç": "‚úÖ –£—Å–ø–µ—à–Ω–æ" if results["integration"]["status"] == "passed" else "‚ùå –û—à–∏–±–∫–∞"
        },
        {
            "–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π": "–†–∞–±–æ—Ç–∞ FSM",
            "–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è": "–°—Ü–µ–Ω–∞—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞": "–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–∞",
            "–†–µ–∑—É–ª—å—Ç–∞—Ç": "‚úÖ –£—Å–ø–µ—à–Ω–æ" if results["integration"]["status"] == "passed" else "‚ùå –û—à–∏–±–∫–∞"
        }
    ]

    # –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã
    print("\n–¢–ê–ë–õ–ò–¶–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø")
    print("=" * 90)
    print(f"{'–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π':<35} {'–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è':<25} {'–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞':<40} {'–†–µ–∑—É–ª—å—Ç–∞—Ç':<10}")
    print("-" * 90)

    for row in report_data:
        print(
            f"{row['–ú–æ–¥—É–ª—å/–°—Ü–µ–Ω–∞—Ä–∏–π']:<35} {row['–ú–µ—Ç–æ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è']:<25} {row['–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞']:<40} {row['–†–µ–∑—É–ª—å—Ç–∞—Ç']:<10}")

    print("=" * 90)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–∞–π–ª
    with open("test_report.json", "w", encoding="utf-8") as f:
        json.dump(report_data, f, ensure_ascii=False, indent=2)

    print("\nüìÑ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ test_report.json")


if __name__ == "__main__":
    run_tests()